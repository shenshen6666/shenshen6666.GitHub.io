<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
<!-- 设置文档字符集为 UTF-8，支持多种语言字符 -->

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- 设置视口，使网页在移动设备上显示的宽度等于设备宽度，初始缩放比例为1.0 -->

<meta http-equiv="X-UA-Compatible" content="ie=edge">
<!-- 设置 IE 浏览器的兼容性模式，使用最新的浏览器渲染引擎 -->

<title>2FA认证 | 申申丫的</title>
<!-- 设置网页标题，使用模板引擎输出网站标题 -->

<link rel="stylesheet" href="https://shenshen6666.GitHub.io/styles/main.css">
<!-- 引入主样式表文件 -->

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- 异步加载不蒜子统计的 JavaScript 文件，用于网站访问量统计 -->


  <!-- 如果当前页面不是首页 -->
  <script src="https://shenshen6666.GitHub.io/media/js/page.js"></script>
  <!-- 引入其他页面特定的 JavaScript 文件 -->


    

  <meta name="description" content="双因素认证（2FA，Two-Factor Authentication）是一种提高安全性的方法，要求用户在登录或进行某些敏感操作时提供两种不同类型的身份验证信息。这种方法通过引入第二层验证，增加了账户被未经授权访问的难度。
项目结构
spr...">
  
  <!-- 资源预加载 -->
  <link rel="preload" href="https://code.jquery.com/jquery-3.6.4.min.js" as="script">
  <link rel="preload" href="https://shenshen6666.GitHub.io/media/js/prism.js" as="script">
  
  <!-- 样式资源 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  <style>
    :root {
      --primary-color: #2c3e50;
      --hover-color: #3498db;
      --shadow-light: 0 2px 5px rgba(0,0,0,0.1);
      --shadow-medium: 0 4px 8px rgba(0,0,0,0.15);
      --transition-fast: all 0.2s ease;
    }

    /* 增强的浮动窗口样式 */
    .zhihu-iframe {
      position: fixed;
      top: 5px;
      left: 75%;
      transform: translateX(-50%);
      z-index: 999;
      display: none;
      resize: both;
      overflow: auto;
      min-width: 200px;
      min-height: 200px;
      max-width: 90vw;
      max-height: 90vh;
      border: 1px solid #e0e0e0;
      background: #fff;
      border-radius: 8px;
      box-shadow: var(--shadow-medium);
      transition: var(--transition-fast);
    }

    .zhihu-iframe::after {
      content: '⤢';
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 16px;
      cursor: se-resize;
      background: linear-gradient(135deg, transparent 45%, #f0f0f0 45%);
    }

    /* 按钮组样式优化 */
    .float-control-group {
      position: fixed;
      right: 20px;
      bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .control-btn {
      cursor: pointer;
      padding: 12px;
      background: rgba(255, 255, 255, 0.95);
      color: var(--primary-color);
      border: 1px solid #e0e0e0;
      border-radius: 50%;
      box-shadow: var(--shadow-light);
      transition: var(--transition-fast);
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    /* 设置按钮特殊样式 */
    .zhihu-iframe .control-btn {
      width: 28px;
      height: 28px;
      padding: 4px;
      font-size: 14px;
      position: absolute;
      left: 10px;
      bottom: 0;
      border-radius: 4px;
      background: transparent;
      border: none;
      box-shadow: none;
    }

    .zhihu-iframe .control-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      transform: none;
      box-shadow: none;
    }

    .control-btn:hover {
      background: #fff;
      color: var(--hover-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }

    /* 增强的菜单样式 */
    .url-menu {
      display: none;
      position: fixed;
      right: 90px;
      bottom: 30px;
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 15px;
      box-shadow: var(--shadow-medium);
      backdrop-filter: blur(8px);
      min-width: 240px;
    }

    .url-menu input {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      transition: var(--transition-fast);
    }

    .url-menu input:focus {
      border-color: var(--hover-color);
      outline: none;
    }

    .url-menu button {
      padding: 6px 12px;
      margin: 4px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #f8f9fa;
      transition: var(--transition-fast);
    }

    .url-menu button:hover {
      background: #e9ecef;
      border-color: var(--hover-color);
    }

    /* 新增灰色按钮样式 */
    .quick-urls button.grey-btn {
      background: #e0e0e0;
      color: #555;
      border: 1px solid #ccc;
    }

    @media (max-width: 768px) {
      .zhihu-iframe {
        left: 50%;
        max-width: 95vw;
      }
      
      .float-control-group {
        right: 10px;
        bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- 主体结构保持不变 -->
  <div class="antialiased">
    <div class="body-width mx-auto px-6 md:px-8">
      
<!-- 使用 Map 存储菜单项和对应的图标类名 -->

<div class="flex justify-between items-center mt-10">
  <!-- 创建顶部导航栏容器 -->
  <h1 class="text-lg sm:text-xl md:text-2xl lg:text-3xl text-gray-900 font-medium md:font-normal leading-none">
    <!-- 创建网站标题部分 -->
    <div class="glitch-wrapper">
      <!-- 创建标题特效容器 -->
      <div class="glitch" data-text="申申丫的">
        <!-- 创建标题特效 -->
        <a href="https://shenshen6666.GitHub.io">申申丫的</a>
        <!-- 显示网站标题并设置链接 -->
      </div>
    </div>
  </h1>
  <div class="block lg:hidden" id="thumb-menu">
    <!-- 创建移动设备下的菜单按钮容器 -->
    <button id="thumb-open" type="button" class="block">
      <!-- 打开菜单的按钮图标 -->
      <i class="icon icon-menu-close"></i>
    </button>
    <button id="thumb-close" type="button" class="hidden">
      <!-- 关闭菜单的按钮图标 -->
      <i class="icon icon-menu-open"></i>
    </button>
  </div>
</div>

<div id="nav-list" class="lg:block hidden">
  <!-- 创建导航列表容器 -->
  <div class="w-full block lg:flex lg:justify-between border-external-bottom lg:border-gray-400 mt-10 text-gray-700 lg:text-lg">
    <!-- 创建导航列表 -->
    <div class="lg:flex -mb-px">
      <!-- 创建导航项容器 -->
      
        <!-- 遍历导航菜单 -->
        
          <!-- 如果是内部链接 -->
          <div class="pb-4">
            <!-- 创建内部链接容器 -->
            <a href="/" class="nav-link">
              <!-- 显示内部链接 -->
              <i class="icon icon-home"></i> 
              <!-- 显示对应图标 -->
              首页
              <!-- 显示菜单项名称 -->
            </a>
          </div>
        
      
        <!-- 遍历导航菜单 -->
        
          <!-- 如果是内部链接 -->
          <div class="pb-4">
            <!-- 创建内部链接容器 -->
            <a href="/archives" class="nav-link">
              <!-- 显示内部链接 -->
              <i class="icon icon-archive"></i> 
              <!-- 显示对应图标 -->
              归档
              <!-- 显示菜单项名称 -->
            </a>
          </div>
        
      
        <!-- 遍历导航菜单 -->
        
          <!-- 如果是内部链接 -->
          <div class="pb-4">
            <!-- 创建内部链接容器 -->
            <a href="/tags" class="nav-link">
              <!-- 显示内部链接 -->
              <i class="icon icon-tags"></i> 
              <!-- 显示对应图标 -->
              标签
              <!-- 显示菜单项名称 -->
            </a>
          </div>
        
      
        <!-- 遍历导航菜单 -->
        
          <!-- 如果是内部链接 -->
          <div class="pb-4">
            <!-- 创建内部链接容器 -->
            <a href="/post/about" class="nav-link">
              <!-- 显示内部链接 -->
              <i class="icon icon-user"></i> 
              <!-- 显示对应图标 -->
              关于
              <!-- 显示菜单项名称 -->
            </a>
          </div>
        
      
        <!-- 遍历导航菜单 -->
        
          <!-- 如果是内部链接 -->
          <div class="pb-4">
            <!-- 创建内部链接容器 -->
            <a href="/essays" class="nav-link">
              <!-- 显示内部链接 -->
              <i class="icon icon-"></i> 
              <!-- 显示对应图标 -->
              测试菜单
              <!-- 显示菜单项名称 -->
            </a>
          </div>
        
      
      <!-- 循环结束 -->
      <div class="search-frame pb-4">
        <!-- 创建搜索框容器 -->
        <i class="icon icon-search"></i>
        <!-- 显示搜索图标 -->
        <form id="search-form" action="https://shenshen6666.GitHub.io/search/">
          <!-- 创建搜索表单 -->
          <input name="searchContent" type="text" placeholder="Search..." />
          <!-- 显示搜索框，并设置占位符 -->
        </form>
      </div>
    </div>

    <div class="lg:flex">
      <!-- 创建右侧导航项容器 -->
      <ul>
        <!-- 创建导航链接列表 -->
        
          <!-- 遍历社交媒体链接 -->
          
        
          <!-- 遍历社交媒体链接 -->
          
        
          <!-- 遍历社交媒体链接 -->
          
        
          <!-- 遍历社交媒体链接 -->
          
        
          <!-- 遍历社交媒体链接 -->
          
        
          <!-- 遍历社交媒体链接 -->
          
        
      </ul>
      <!-- 社交媒体链接列表结束 -->

      <a href="https://shenshen6666.GitHub.io/atom.xml" class="block mt-4 lg:mt-0 lg:ml-8 align-center hover:text-gray-900" target="_blank">
        <!-- 创建 RSS 订阅链接 -->
        <i class="icon icon-rss"></i>
        <!-- 显示 RSS 图标 -->
        RSS
        <!-- 显示 RSS 文字 -->
      </a>
    </div>
  </div>
</div>


      <div class="mb-20 md:flex mt-10 lg:mt-6 md:border-internal md:border-gray-400 md:pt-2 lg:border-t-0 lg:pt-0">
        <!-- 左侧内容保持不变 -->
        <div class="w-full md:w-2/3 mt-6">
          <h1 class="post-title text-3xl">2FA认证</h1>
          
          <div class="mt-6 lg:mt-10 post-content">
            <p>双因素认证（2FA，Two-Factor Authentication）是一种提高安全性的方法，要求用户在登录或进行某些敏感操作时提供两种不同类型的身份验证信息。这种方法通过引入第二层验证，增加了账户被未经授权访问的难度。</p>
<h3 id="项目结构">项目结构</h3>
<pre><code>spring-boot-2fa-demo
├── src
│   ├── main
│   │   ├── java
│   │   │   └── com
│   │   │       └── example
│   │   │           └── demo
│   │   │               ├── DemoApplication.java
│   │   │               ├── security
│   │   │               │   ├── SecurityConfig.java
│   │   │               │   ├── TotpAuthenticationFilter.java
│   │   │               │   ├── TotpAuthenticationProvider.java
│   │   │               │   ├── TotpAuthenticationToken.java
│   │   │               │   └── TotpAuthenticator.java
│   │   │               └── web
│   │   │                   ├── TotpSetupController.java
│   │   │                   └── TotpVerifyController.java
│   └── main
│       └── resources
│           └── application.properties
└── pom.xml
</code></pre>
<h3 id="1-pomxml">1. <code>pom.xml</code></h3>
<pre><code class="language-xml">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;demo&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;spring-boot-2fa-demo&lt;/name&gt;
    &lt;description&gt;Spring Boot 2FA Demo&lt;/description&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.7.0&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;
    &lt;dependencies&gt;
        &lt;!-- Spring Boot Starter Web --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- Spring Boot Starter Security --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- TOTP Library --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;de.taimos&lt;/groupId&gt;
            &lt;artifactId&gt;totp&lt;/artifactId&gt;
            &lt;version&gt;1.0.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- Spring Boot Starter Test --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;
</code></pre>
<h3 id="2-demoapplicationjava">2. <code>DemoApplication.java</code></h3>
<pre><code class="language-java">package com.example.demo;  
  
import com.example.demo.demo.security.TotpAuthenticator;  
import org.springframework.boot.SpringApplication;  
import org.springframework.boot.autoconfigure.SpringBootApplication;  
import org.springframework.context.ApplicationContext;  
  
@SpringBootApplication  
public class DemoApplication {  
  
    public static void main(String[] args) {  
        ApplicationContext context = SpringApplication.run(DemoApplication.class, args);  
        String[] beanNames = context.getBeanNamesForType(TotpAuthenticator.class);  
        for (String beanName : beanNames) {  
            System.out.println(&quot;Found bean: &quot; + beanName);  
        }
    }
}
        ```

### 3. Security 配置

#### `SecurityConfig.java`

```java
package com.example.demo.demo.security;  
  
  
import org.springframework.context.annotation.Configuration;  
import org.springframework.security.config.annotation.web.builders.HttpSecurity;  
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;  
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;  
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;  
  
@Configuration  
@EnableWebSecurity  
public class SecurityConfig extends WebSecurityConfigurerAdapter {  
  
    @Override  
    protected void configure(HttpSecurity http) throws Exception {  
        http  
                .authorizeRequests()  
                // 配置不需要认证的路径  
                .antMatchers(&quot;/login&quot;, &quot;/totp-setup&quot;, &quot;/totp-verify&quot;, &quot;/auth/*&quot;,&quot;/test/*&quot;).permitAll()  
                .anyRequest().authenticated()  
                .and()  
                .formLogin()  
                .loginPage(&quot;/login&quot;)  
                .defaultSuccessUrl(&quot;/totp-verify&quot;)  
                .permitAll()  
                .and()  
                // 在用户名密码过滤器之前添加 TOTP 认证过滤器  
                .addFilterBefore(new TotpAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class);  
    }  
}
</code></pre>
<h4 id="totpauthenticationfilterjava"><code>TotpAuthenticationFilter.java</code></h4>
<pre><code class="language-java">package com.example.demo.demo.security;  
  
import org.springframework.security.core.Authentication;  
import org.springframework.security.core.context.SecurityContextHolder;  
import org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter;  
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;  
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;  
  
import javax.servlet.FilterChain;  
import javax.servlet.ServletException;  
import javax.servlet.http.HttpServletRequest;  
import javax.servlet.http.HttpServletResponse;  
import java.io.IOException;  
  
public class TotpAuthenticationFilter extends AbstractAuthenticationProcessingFilter {  
  
    public TotpAuthenticationFilter() {  
        super(new AntPathRequestMatcher(&quot;/totp-verify&quot;));  
    }  
    @Override  
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response)  
            throws IOException, ServletException {  
        String totp = request.getParameter(&quot;totp&quot;);  
        String username = request.getParameter(&quot;username&quot;);  
  
        // 创建 TOTP 认证令牌  
        TotpAuthenticationToken token = new TotpAuthenticationToken(username, totp);  
        return this.getAuthenticationManager().authenticate(token);  
    }  
    @Override  
    protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response,  
                                            FilterChain chain, Authentication authResult)  
            throws IOException, ServletException {  
        SecurityContextHolder.getContext().setAuthentication(authResult);  
        chain.doFilter(request, response);  
    }
}
    ```

#### `TotpAuthenticationProvider.java`

```java
package com.example.demo.demo.security;  
  
  
import org.springframework.beans.factory.annotation.Autowired;  
import org.springframework.security.authentication.AuthenticationProvider;  
import org.springframework.security.core.Authentication;  
import org.springframework.security.core.AuthenticationException;  
import org.springframework.security.core.userdetails.UserDetailsService;  
  
public class TotpAuthenticationProvider implements AuthenticationProvider {  
  
    @Autowired  
    private TotpAuthenticator totpAuthenticator;  
  
    @Autowired  
    private UserDetailsService userDetailsService;  
  
    @Override  
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {  
        String username = authentication.getName();  
        String totp = (String) authentication.getCredentials();  
  
        // 验证 TOTP        if (totpAuthenticator.verifyTotp(username, Integer.parseInt(totp))) {  
            return new TotpAuthenticationToken(username, totp,  
                    userDetailsService.loadUserByUsername(username).getAuthorities());  
        }  
        return null;  
    }  
    @Override  
    public boolean supports(Class&lt;?&gt; authentication) {  
        return TotpAuthenticationToken.class.isAssignableFrom(authentication);  
    }
}
</code></pre>
<h4 id="totpauthenticationtokenjava"><code>TotpAuthenticationToken.java</code></h4>
<pre><code class="language-java">package com.example.demo.demo.security;  
  
  
import org.springframework.security.authentication.AbstractAuthenticationToken;  
import org.springframework.security.core.GrantedAuthority;  
  
import java.util.Collection;  
  
public class TotpAuthenticationToken extends AbstractAuthenticationToken {  
  
    private final Object principal;  
    private Object credentials;  
  
    public TotpAuthenticationToken(Object principal, Object credentials) {  
        super(null);  
        this.principal = principal;  
        this.credentials = credentials;  
        setAuthenticated(false);  
    }  
    public TotpAuthenticationToken(Object principal, Object credentials,  
                                   Collection&lt;? extends GrantedAuthority&gt; authorities) {  
        super(authorities);  
        this.principal = principal;  
        this.credentials = credentials;  
        setAuthenticated(true);  
    }  
    @Override  
    public Object getCredentials() {  
        return this.credentials;  
    }  
    @Override  
    public Object getPrincipal() {  
        return this.principal;  
    }  
    @Override  
    public void eraseCredentials() {  
        super.eraseCredentials();  
        credentials = null;  
    }
}

</code></pre>
<h4 id="totpauthenticatorjava"><code>TotpAuthenticator.java</code></h4>
<pre><code class="language-java">package com.example.demo.demo.security;  
  
  
import com.warrenstrange.googleauth.GoogleAuthenticator;  
import com.warrenstrange.googleauth.GoogleAuthenticatorKey;  
import com.warrenstrange.googleauth.GoogleAuthenticatorQRGenerator;  
import org.springframework.stereotype.Component;  
  
/**  
 * @author lei  
 */@Component  
public class TotpAuthenticator {  
  
    private final GoogleAuthenticator gAuth = new GoogleAuthenticator();  
  
    // 生成 TOTP 密钥并返回 GoogleAuthenticatorKey 对象  
    public GoogleAuthenticatorKey generateSecret() {  
        return gAuth.createCredentials();  
    }  
    // 获取 TOTP QR 码 URL    public String getQRCode(GoogleAuthenticatorKey secret, String account) {  
        return GoogleAuthenticatorQRGenerator.getOtpAuthTotpURL(account, &quot;SpringBootDemo&quot;, secret);  
    }  
    // 验证 TOTP    public boolean verifyTotp(String secret, int verificationCode) {  
        return gAuth.authorize(secret, verificationCode);  
    }
}

</code></pre>
<h3 id="4-控制器">4. 控制器</h3>
<h4 id="totpsetupcontrollerjava"><code>TotpSetupController.java</code></h4>
<pre><code class="language-java">package com.example.demo.demo.web;  
  
import com.example.demo.demo.dto.QRCodeResponse;  
import com.example.demo.demo.security.TotpAuthenticator;  
import com.warrenstrange.googleauth.GoogleAuthenticatorKey;  
import org.springframework.web.bind.annotation.*;  
  
import java.util.HashMap;  
import java.util.Map;  
  
@RestController  
@RequestMapping(&quot;/auth&quot;)  
public class TotpSetupController {  
  
    private final TotpAuthenticator totpAuthenticator;  
  
    public TotpSetupController(TotpAuthenticator totpAuthenticator) {  
        this.totpAuthenticator = totpAuthenticator;  
    }  
  
    // 设置 TOTP 密钥并返回 QR 码 URL    @GetMapping(&quot;/totp-setup&quot;)  
    public Map&lt;String, String&gt; setupTotp(@RequestParam String username) {  
        // 写死一个 TOTP 密钥  
        String hardCodedSecret = &quot;OZSNQGV44RGY63BL&quot;;  
        GoogleAuthenticatorKey googleAuthenticatorKey = new GoogleAuthenticatorKey.Builder(hardCodedSecret).build();  
        String qrCodeUrl = totpAuthenticator.getQRCode(googleAuthenticatorKey, username);  
  
        Map&lt;String, String&gt; response = new HashMap&lt;&gt;();  
        response.put(&quot;secret&quot;, hardCodedSecret);  
        response.put(&quot;qrCodeUrl&quot;, qrCodeUrl);  
  
        return response;  
    }  
    // 设置 TOTP 密钥并返回 QR 码 URL    @GetMapping(&quot;/totp-setup1&quot;)  
    public QRCodeResponse setupTotp1(@RequestParam String username) {  
        GoogleAuthenticatorKey googleAuthenticatorKey = totpAuthenticator.generateSecret();  
        // 保存密钥与用户名的关联关系，可以使用数据库等存储  
        // 这里只是示例，没有实际存储  
  
        String qrCodeUrl = totpAuthenticator.getQRCode(googleAuthenticatorKey, username);  
        return new QRCodeResponse(googleAuthenticatorKey.getKey(), qrCodeUrl);  
    }  
}
</code></pre>
<h4 id="totpverifycontrollerjava"><code>TotpVerifyController.java</code></h4>
<pre><code class="language-java">package com.example.demo.demo.web;  
  
  
import com.example.demo.demo.security.TotpAuthenticator;  
import org.springframework.security.core.context.SecurityContextHolder;  
import org.springframework.web.bind.annotation.*;  
  
@RestController  
@RequestMapping(&quot;/test&quot;)  
public class TotpVerifyController {  
  
    private final TotpAuthenticator totpAuthenticator;  
  
    public TotpVerifyController(TotpAuthenticator totpAuthenticator) {  
        this.totpAuthenticator = totpAuthenticator;  
    }  
  
    @GetMapping(&quot;/totp-verify&quot;)  
    public String verifyTotp(@RequestParam int totp) {  
        String username = SecurityContextHolder.getContext().getAuthentication().getName();  
        // 从存储中获取与用户名关联的密钥，这里假设已获取  
        String secret = &quot;OZSNQGV44RGY63BL&quot;;  
  
        if (totpAuthenticator.verifyTotp(secret, totp)) {  
            return &quot;2FA 成功!&quot;;  
        } else {  
            return &quot;无效的 TOTP!&quot;;  
        }    }  
  
    @GetMapping(&quot;/test1&quot;)  
    public String test() {  
        return &quot;hell1&quot;;  
    }}
</code></pre>
<h3 id="5-配置文件">5. 配置文件</h3>
<h4 id="applicationproperties"><code>application.properties</code></h4>
<pre><code class="language-properties">server.port=8080
spring.application.name=2FA-Demo
</code></pre>
<h3 id="6-启动项目">6. 启动项目</h3>
<p>确保所有代码都已编写完成，然后运行 <code>DemoApplication.java</code> 启动项目。你可以通过以下步骤测试 2FA 功能：</p>
<ol>
<li>访问 <code>/totp-setup</code> 端点生成 TOTP 密钥和 QR 码。</li>
<li>使用 Google Authenticator 扫描 QR 码。</li>
<li>访问 <code>/totp-verify</code> 端点并输入 Google Authenticator 生成的一次性密码。</li>
</ol>
<ul>
<li>接口输出url可通过二下面工具生成</li>
<li>二维码工具：https://www.runoob.com/try/try.php?filename=tryhtml5_QRCode</li>
</ul>

          </div>
        </div>

        <!-- 右侧内容优化分组 -->
        <div class="w-full md:w-1/3 mt-6 md:pl-8" id="additionalContent">
          <div class="sidebar-section">
            <!-- 信息模块保持不变 -->
            
  <!-- 检查是否存在微信支付二维码 -->
  <h4 class="text-base font-thin text-gray-700 mb-2 mt-6">
    <!-- 赞赏标题 -->
    <i class="icon icon-sponsor"></i>
    <!-- 赞赏图标 -->
    赞赏
    <!-- 赞赏文本 -->
  </h4>
  <div class="post-sponsor text-gray-700">
    <!-- 赞赏内容容器 -->
    <img class="post-sponsor-img w-32 h-32 md:w-40 md:h-40" src="https://shenshen6666.GitHub.io\media\images\custom-weChatPayQR.png" alt="">
    <!-- 微信支付二维码 -->
    <div>
      <!-- 支付提示 -->
      <i class="icon icon-wechat"></i>
      <!-- 微信图标 -->
      支付宝扫一扫领红包
      <!-- 支付宝提示 -->
    </div>
  </div>


          </div>

          <!-- 浮动窗口和控件 -->
          <style>
            /* 滑动条样式 */
            .url-slider {
              position: absolute;
              bottom: 0;
              left: 0;
              right: 0;
              height: 30px;
              background: rgba(255, 255, 255, 0.95);
              border-top: 1px solid #e0e0e0;
              display: flex;
              align-items: center;
              padding: 0 10px;
            }
          
            .url-list {
              width: 100%;
              overflow-x: auto;
              white-space: nowrap;
              scrollbar-width: thin;
              padding: 5px 0;
            }
          
            .url-item {
              display: inline-block;
              padding: 4px 8px;
              margin: 0 4px;
              background: #f0f0f0;
              border-radius: 4px;
              cursor: pointer;
            }
          
            .url-item.active {
              background: var(--hover-color);
              color: white;
            }
          </style>
          
          <!-- 在 body 中的浮动窗口部分 -->
                  <div class="zhihu-iframe mt-6">
                    <iframe src="https://onehu.xyz/" style="width:100%;height:calc(100% - 30px);border:none;"></iframe>
                    <div class="url-slider">
                      <div class="url-list" id="urlList"></div>
                    </div>
            <button class="control-btn" id="menuButton">⚙️</button>
            <div class="url-menu">
              <input type="text" id="customUrl" placeholder="输入自定义网址" class="url-input">
              <div class="quick-urls">
                <button class="grey-btn" data-url="https://onehu.xyz/">默认</button>
                <button class="grey-btn" data-url="https://novelsj.xyz/">盐王</button>
                <button data-url="https://www.bilibili.com/">哔哩哔哩</button>
              </div>
              <button class="confirm-btn" id="applyUrl">确定</button>
            </div>
          </div>

          <!-- 控件按钮组 -->
          <div class="float-control-group">
            <button class="control-btn" id="toggleButton">↔️</button>
            <button class="control-btn" id="moveUpButton">↑</button>
            <button class="control-btn" id="moveDownButton">↓</button>
          </div>
        </div>
      </div>

      <div class="footer border-gray-400 border-external-top pt-6 mt-6 sm:mt-8 md:mt-10 mb-20 text-gray-700 text-sm sm:text-base lg:text-lg">
  <!-- 创建页脚容器，设置边框和样式 -->
  Powered by <a href="https://github.com/shenshen6666/shenshen6666.GitHub.io" target="_blank">我的小屋</a>
  <!-- 显示页脚信息 -->
</div>

    </div>
  </div>

  <!-- 脚本优化 -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://shenshen6666.GitHub.io/media/js/prism.js"></script>
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

  <script>
    (function() {
      'use strict';
      
      // 模块初始化
      const uiModule = (() => {
        const elements = {
          iframe: document.querySelector('.zhihu-iframe'),
          toggleBtn: $('#toggleButton'),
          moveUpBtn: $('#moveUpButton'),
          moveDownBtn: $('#moveDownButton'),
          menu: $('.url-menu'),
          menuBtn: $('#menuButton')
        };

        // 位置控制
        const moveFrame = (direction) => {
          const current = parseFloat(elements.iframe.style.top) || 5;
          elements.iframe.style.top = `${current + (direction === 'up' ? -10 : 10)}px`;
        };

        // URL 控制
        const updateFrameUrl = (url) => {
          elements.iframe.querySelector('iframe').src = url;
        };

        return {
          init() {
            // 初始尺寸
            elements.iframe.style.width = '320px';
            elements.iframe.style.height = '500px';

            // 事件绑定
            elements.toggleBtn.on('click', () => {
              $('.zhihu-iframe, #additionalContent .mt-6').toggle();
            });

            elements.moveUpBtn.on('click', () => moveFrame('up'));
            elements.moveDownBtn.on('click', () => moveFrame('down'));

            // 点击菜单按钮时切换显示状态
            elements.menuBtn.on('click', (e) => {
              e.stopPropagation();
              elements.menu.toggle();
            });

            // “默认”、“盐王”按钮：点击后立即更新 URL 并关闭菜单
            $('.url-menu button[data-url]').on('click', function(e) {
              e.stopPropagation();
              const url = $(this).data('url');
              const btnText = $(this).text();
              if (btnText === '默认' || btnText === '盐王') {
                updateFrameUrl(url);
                elements.menu.hide();
              } else if (btnText === '哔哩哔哩') {
                // 只更新输入框，不关闭菜单
                $('#customUrl').val(url);
              }
            });

            // “确定”按钮：只有点击后才会关闭菜单
            $('#applyUrl').on('click', (e) => {
              e.stopPropagation();
              const url = $('#customUrl').val();
              if (url) {
                updateFrameUrl(url);
                elements.menu.hide();
              }
            });

            // 阻止菜单内部点击时冒泡（防止因外部绑定而意外关闭）
            elements.menu.on('click', (e) => {
              e.stopPropagation();
            });
          }
        };
      })();

      // 初始化模块
      document.addEventListener('DOMContentLoaded', () => {
        uiModule.init();
        Prism.highlightAll();
      });
    })();
  </script>
</body>
</html>
